<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <script src="lib/jquery-3.1.1.min.js"></script>
    <script src="lib/jquery.easing.1.3.js"></script>
    <script src="lib/velocity.min.js"></script>
    <script src="lib/autosize.min.js"></script>
    <link rel="stylesheet" href="font-awesome-4.7.0/css/font-awesome.min.css" />
    <script>
      window.jQuery = window.$ = require('./lib/jquery-3.1.1.min.js')
      window.velocity = require('./lib/velocity.min.js')
      window.autosize = require('./lib/autosize.min.js')
      const shell = require('electron').shell
      const ipcRenderer = require('electron').ipcRenderer
      const app = require('electron').remote.app
      const Config = require('electron-store')
      const store = new Config()

      var token
      var myUserId, myUsername
      var selectedTab = 0

      var latestStreamPostId = 0
      var latestGlobalPostId = 0
      var latestMentionsPostId = 0
      var latestInteractionsId = 0

      var loading_stream = false
      var loading_mentions = false
      var loading_global = false
      var loading_interactions = false

      var irtPostId

      var uploadFile = null

      $(document).ready(function () {
        autosize($('#composeTextArea'))

        //init layout
        $(window).resize(function () {
          $('#innerComposeScreen').width(window.innerWidth - 72)

          if (process.platform == 'darwin') {
            if (window.innerWidth > 290) {
              $('#titlebar-center .titlebar-button').velocity(
                { width: 24 },
                { queue: false }
              )
              $('#titlebar-center').velocity({ paddingLeft: 0 }, { queue: false })
            } else {
              $('#titlebar-center .titlebar-button').velocity(
                { width: 20 },
                { queue: false }
              )
              $('#titlebar-center').velocity({ paddingLeft: 24 }, { queue: false })
            }
          } else {
            if (window.innerWidth > 320) {
              $('#titlebar-center .titlebar-button').velocity(
                { width: 24 },
                { queue: false }
              )
            } else {
              $('#titlebar-center .titlebar-button').velocity(
                { width: 20 },
                { queue: false }
              )
            }
          }
        })

        $(window).resize()

        //titlebar
        if (process.platform == 'darwin') {
          $('#titlebar-edge').css({ right: '11px' })
        } else {
          $('#titlebar-center').css({
            marginLeft: '38px',
            textAlign: 'left',
            paddingLeft: '10px',
            borderLeft: '1px solid #bbb',
          })
          $('#titlebar').css({ backgroundColor: '#000' })

          $('.postthread-close').css({
            textAlign: 'left',
            paddingLeft: '12px',
          })
          $('#backToStreamIcon').removeClass('fa-cheveron-left')
          $('#backToStreamIcon').addClass('fa-arrow-circle-left')

          $('#titlebar-edge').css({ left: '11px' })
          $('body').append(
            '<div id="windowControl">' +
              '<span id="winMinimize" class="windowControlButton">' +
              '<svg x="0px" y="0px" viewBox="0 0 10 10"><rect fill="#ffffff" width="10" height="1" transform="translate(0, 5)"></rect></svg>' +
              '</span>' +
              '<span id="winMaximize" class="windowControlButton">' +
              '<svg class="fullscreen-svg" x="0px" y="0px" viewBox="0 0 10 10"><path fill="#ffffff" d="M 0 0 L 0 10 L 10 10 L 10 0 L 0 0 z M 1 1 L 9 1 L 9 9 L 1 9 L 1 1 z "/></svg>' +
              '</span>' +
              '<span id="winClose" class="windowControlButton">' +
              '<svg x="0px" y="0px" viewBox="0 0 10 10"><polygon fill="#ffffff" points="10,1 9,0 5,4 1,0 0,1 4,5 0,9 1,10 5,6 9,10 10,9 6,5"></polygon></svg>' +
              '</span>' +
              '</div>'
          )
        }

        $(document).on('click', '#winClose', function () {
          window.close()
        })
        $(document).on('click', '#winMaximize', function () {
          ipcRenderer.send('winMaximize')
        })
        $(document).on('click', '#winMinimize', function () {
          ipcRenderer.send('winMinimize')
        })

        //HIDDEN COMMAND!

        var input = []
        var command = [38, 38, 40, 40, 37, 39, 37, 39, 66, 65]

        $(window).keyup(function (e) {
          input.push(e.keyCode)

          if (input.toString().indexOf(command) >= 0) {
            if (store.get('theme', 'light') != 'cyber') {
              store.set('theme', 'cyber')
              $('#windowContents').append(
                '<div id="hiddenFeatureOverlay"><img src="img/enuts-80s-effect.gif?' +
                  new Date().getTime() +
                  '"></div>'
              )
              $('#hiddenFeatureOverlay').show()
              $('#hiddenFeatureOverlay').velocity('fadeOut', {
                duration: 1000,
                delay: 4000,
                complete: function () {
                  $('#hiddenFeatureOverlay').remove()
                },
              })
              $('#hiddenFeatureNotify').velocity('slideDown', {
                duration: 500,
                delay: 4000,
              })
              $('#hiddenFeatureNotify').velocity('fadeOut', {
                duration: 3000,
                delay: 7000,
              })
            } else {
              store.set('theme', 'light')
            }

            initBySettings()

            input = []
          }
        })

        //----

        setInterval("getStream('stream')", 30000)
        setInterval("getStream('mentions')", 30000)
        setInterval("getStream('global')", 30000)
        setInterval('getInteractions()', 30000)

        ipcRenderer.on('refresh', function () {
          getStream('stream')
          getStream('global')
          getStream('mentions')
          getInteractions()
        })

        if (store.get('updateCheck', true)) {
          updateCheck()
        }

        initBySettings()

        function initBySettings() {
          if (store.get('roundedIcon', true)) {
            $('#windowContents').addClass('streams-rounded-icon')
          } else {
            $('#windowContents').removeClass('streams-rounded-icon')
          }

          if (store.get('showDisplayName', true)) {
            $('#windowContents').addClass('streams-show-displayname')
          } else {
            $('#windowContents').removeClass('streams-show-displayname')
          }

          $('body').removeClass('theme-dark')
          $('body').removeClass('theme-cyber')
          $('body').addClass('theme-' + store.get('theme', 'light'))

          updateRelativeDate()
        }

        function updateCheck() {
          var myVersion = app.getVersion()
          var newVersion

          $.get(
            {
              url: 'https://api.github.com/repos/kyo5884/enuts/releases/latest',
              async: false,
              cache: false,
            },
            function (data) {
              console.log(data)
              newVersion = data.tag_name

              if ('v' + myVersion != newVersion) {
                $('#updateNotifyNewVersion').text(newVersion)
                $('#updateNotify').velocity('slideDown')
              }
            }
          )
        }

        $('#updateNotifyClose').click(function () {
          $('#updateNotify').velocity('slideUp')
        })

        setInterval(function () {
          updateRelativeDate()
        }, 10000)

        function updateRelativeDate() {
          // for (var i = 0; $(".post").length > i; i++) {
          //     var relTime = getRelativeDate($(".post:eq(" + i + ")").attr("post_created_at"));
          //     $(".post:eq(" + i + ") .postRelDateText").text(relTime);
          // }

          $('.streams .post').each(function () {
            var relTime = getRelativeDate($(this).attr('post_created_at'))
            $(this).find('.postRelDateText').text(relTime)
          })
        }

        $('#titlebar-center .titlebar-button').click(function () {
          tabSelect($(this).index())
        })

        $(document).on(
          'click',
          '.usericon, .username, #profileFollowing .postcontent, #profileFollowers .postcontent',
          function () {
            var username = '@' + $(this).closest('.post').find('.username').text()
            tabSelect(4, username)
          }
        )

        $(document).on('click', 'span[itemprop=mention]', function () {
          var username = $(this).text()
          tabSelect(4, username)
        })

        $('#profile').scroll(function () {
          var scrollTop = $('#profile').scrollTop()

          if (140 - scrollTop >= 40) {
            $('#profileHeaderImage').height(140 - scrollTop)
          } else {
            $('#profileHeaderImage').height(40)
          }

          if (scrollTop <= 300) {
            $('#profileHeaderImage').css({
              filter: 'blur(' + scrollTop * 0.1 + 'px)',
            })
          } else {
            $('#profileHeaderImage').css({ filter: 'blur(' + 30 + 'px)' })
          }
        })

        ipcRenderer.on('menu', (e, msg) => {
          switch (msg) {
            case 'new':
              openComposeScreen()
              break
            case 'stream':
              tabSelect(0)
              break
            case 'mentions':
              tabSelect(1)
              break
            case 'interactions':
              tabSelect(2)
              break
            case 'global':
              tabSelect(3)
              break
            case 'profile':
              tabSelect(4)
              break
            case 'search':
              tabSelect(5)
              break
          }
        })

        ipcRenderer.on('settingsUpdated', (e, msg) => {
          initBySettings()
        })

        $('#composeButton').click(function () {
          openComposeScreen()
        })

        $('#composeTextArea').bind('keydown keyup keypress change', function () {
          var lengthString = $(this).val()
          if ($(this).val().match('(?:__|[*#])|[(.*?)](.*?)')) {
            lengthString = $(this)
              .val()
              .replace(/\[([^\]]+)\][^\)]+\)/g, '$1')
          }

          var remain = 256 - lengthString.length
          $('#composeCharRemain').text(remain)
          if (remain < 0) {
            $('#composeCharRemain').css('color', 'red')
          } else {
            $('#composeCharRemain').css('color', '#777')
          }

          if ($('.postthread').length) {
            $('.postthread').css({
              marginTop: $('#composeScreen').outerHeight() + 'px',
            })
          }
        })

        $('#composeTextArea').keydown(function (e) {
          if (e.keyCode == 27) {
            closeComposeScreen()
          }
          if (e.metaKey || e.ctrlKey) {
            if (e.keyCode == 13) {
              composePost()
            }
          }
        })

        $('#composePostButton').click(function () {
          composePost()
        })

        $('#composeCancelButton').click(function () {
          closeComposeScreen()
        })

        $(document).on('mouseenter', '.post', function () {
          $($(this).find('.postDateText')).hide()
          $($(this).find('.postcontrol')).show()
        })
        $(document).on('mouseleave', '.post', function () {
          $($(this).find('.postcontrol')).hide()
          $($(this).find('.postDateText')).show()
        })

        $(document).on('click', 'a[href^="http"]', function (event) {
          event.preventDefault()
          shell.openExternal(this.href)
        })

        $(document).on('dblclick', '.post', function () {
          getConversations($(this).attr('post_id'))
        })

        $(document).on('click', '.post-interaction .posttext', function () {
          getConversations($(this).parents('.post').attr('post_id'))
        })

        $(document).on('click', '.postDetailButton', function () {
          getConversations($(this).parents('.post').attr('post_id'))
        })

        $('.streams').scroll(function () {
          if (this.scrollTop == 0) {
            $('#' + this.id + 'Button').removeClass('unread-indicator')
          }
        })

        function getConversations(id) {
          $.ajax({
            url: 'https://api.pnut.io/v0/posts/' + id + '/thread',
            type: 'GET',
            headers: { Authorization: 'Bearer ' + token },
            data: {
              count: 200,
              include_post_raw: 1,
              include_bookmarked_by: 1,
              include_reposted_by: 1,
            },
            success: function (result) {
              console.log(result)

              var postDetailHtml = ''
              if (result.data.length) {
                for (var i in result.data) {
                  if (!result.data[i].is_deleted) {
                    var postDate = new Date(
                      result.data[i].created_at
                    ).toLocaleString()
                    var postRelativeDate = getRelativeDate(postDate, true)
                    var displayname = ''
                    var postDetailData = ''
                    var postBookmarkedBy = ''
                    var postRepostedBy = ''
                    var postMiniDate = ''

                    var postImage = ''

                    var deleteButton,
                      postclass = ''

                    if (result.data[i].user.id == myUserId) {
                      postclass = postclass + ' post-mypost'
                    } else {
                      deleteButton = ''
                    }

                    if (result.data[i].you_bookmarked) {
                      postclass = postclass + ' post-bookmarked'
                    }

                    if (result.data[i].you_reposted) {
                      postclass = postclass + ' post-reposted'
                    }

                    if (result.data[i].user.name != undefined) {
                      displayname =
                        '<span class="displayname">' +
                        result.data[i].user.name +
                        '</span>'
                    }

                    if ('raw' in result.data[i]) {
                      if (result.data[i].raw.length) {
                        for (var j in result.data[i].raw) {
                          if (result.data[i].raw[j].value.type == 'photo') {
                            var imgUrl = result.data[i].raw[j].value.url
                            var thumbnailImgUrl =
                              result.data[i].raw[j].value.thumbnail_url ||
                              result.data[i].raw[j].value.url
                            if (imgUrl.startsWith('http')) {
                              postImage =
                                postImage +
                                '<a href="' +
                                imgUrl +
                                '"><img class="postimage" src="' +
                                thumbnailImgUrl +
                                '"></a><br>'
                            }
                          }
                        }
                      }
                    }
                    if (result.data[i].content.entities.links.length) {
                      for (var j in result.data[i].content.entities.links) {
                        var url = result.data[i].content.entities.links[j].link
                        if (
                          url.match(/.*\.png|.*\.jpeg|.*\.jpg|.*\.gif/) &&
                          url.startsWith('http')
                        ) {
                          postImage =
                            postImage +
                            '<a href="' +
                            url +
                            '"><img class="postimage" src="' +
                            url +
                            '"></a><br>'
                        }
                      }
                    }

                    if (result.data[i].id != id) {
                      postclass = postclass + ' postthread-mentions'
                      postMiniDate =
                        '<span class="postDateText"><span class="postRelDateText">' +
                        postRelativeDate +
                        '</span></span>'
                    } else {
                      if (postRelativeDate == 'now') {
                        postRelativeDate =
                          ' (<span class="postRelDateText">' +
                          postRelativeDate +
                          '</span>)'
                      } else {
                        postRelativeDate =
                          ' (<span class="postRelDateText">' +
                          postRelativeDate +
                          '</span> ago)'
                      }

                      if (result.data[i].bookmarked_by.length) {
                        var postBookmarkedByList = ''

                        for (var j in result.data[i].bookmarked_by) {
                          if (result.data[i].bookmarked_by[j].name == undefined) {
                            result.data[i].bookmarked_by[j].name = ''
                          }

                          postBookmarkedByList +=
                            '<div class="post">' +
                            '<img class="usericon" src="' +
                            result.data[i].bookmarked_by[j].content.avatar_image
                              .link +
                            '"> ' +
                            '<span class="username">' +
                            result.data[i].bookmarked_by[j].username +
                            '</span> ' +
                            '<span class="displayname">' +
                            result.data[i].bookmarked_by[j].name +
                            '</span><br>' +
                            '</div>'
                        }

                        postBookmarkedBy =
                          '<div class="post-bookmarked-by">' +
                          'Bookmarked by <br>' +
                          postBookmarkedByList +
                          '</div>'
                      }

                      if (result.data[i].reposted_by.length) {
                        var postRepostedByList = ''

                        for (var j in result.data[i].reposted_by) {
                          if (result.data[i].reposted_by[j].name == undefined) {
                            result.data[i].reposted_by[j].name = ''
                          }

                          postRepostedByList +=
                            '<div class="post">' +
                            '<img class="usericon" src="' +
                            result.data[i].reposted_by[j].content.avatar_image.link +
                            '"> ' +
                            '<span class="username">' +
                            result.data[i].reposted_by[j].username +
                            '</span> ' +
                            '<span class="displayname">' +
                            result.data[i].reposted_by[j].name +
                            '</span><br>' +
                            '</div>'
                        }

                        postRepostedBy =
                          '<div class="post-reposted-by">' +
                          'Reposted by <br>' +
                          postRepostedByList +
                          '</div>'
                      }

                      postDetailData =
                        '<div class="postthread-postdatetext">' +
                        postDate +
                        postRelativeDate +
                        '</div>' +
                        '<div class="postvia">' +
                        'Posted via ' +
                        '<a href="' +
                        result.data[i].source.link +
                        '">' +
                        result.data[i].source.name +
                        '</a>' +
                        '</div>' +
                        '<div class="postcounts">' +
                        '<span class="fa fa-reply fa-fw"></span>' +
                        result.data[i].counts.replies +
                        ' <span class="fa fa-star fa-fw"></span>' +
                        result.data[i].counts.bookmarks +
                        '</span>' +
                        ' <span class="fa fa-retweet fa-fw"></span>' +
                        result.data[i].counts.reposts +
                        '</span>' +
                        '</div>' +
                        '<div style="clear: both;"></div>'
                    }
                    postDetailHtml =
                      postDetailHtml +
                      '<div class="post ' +
                      postclass +
                      '" post_id=' +
                      result.data[i].id +
                      ' post_created_at="' +
                      result.data[i].created_at +
                      '">' +
                      '<img class="usericon" src="' +
                      result.data[i].user.content.avatar_image.link +
                      '">' +
                      '<div class="postcontent">' +
                      '<div class="usernameArea">' +
                      '<span class="username">' +
                      result.data[i].user.username +
                      '</span> ' +
                      displayname +
                      '</div>' +
                      '<div class="postdate">' +
                      postMiniDate +
                      '<div class="postcontrol">' +
                      '<span class="fa fa-reply fa-fw postReplyButton"></span>' +
                      '<span class="fa fa-star fa-fw postStarButton"></span>' +
                      '<span class="fa fa-retweet fa-fw postRepostButton"></span>' +
                      '<span class="fa fa-trash-o fa-fw postDeleteButton"></span>' +
                      '<span class="fa fa-ellipsis-h fa-fw postDetailButton"></span>' +
                      '</div>' +
                      '</div>' +
                      '<div class="posttext">' +
                      result.data[i].content.html +
                      '</div>' +
                      postImage +
                      postDetailData +
                      postBookmarkedBy +
                      postRepostedBy +
                      '</div>' +
                      '</div>'
                  }
                }

                $('#windowContents').append(
                  '<div class="postthread" style="margin-top: ' +
                    window.innerHeight +
                    'px">' +
                    postDetailHtml +
                    '</div>'
                )

                $('.postthread').height(window.innerHeight - 40)

                $('#titlebar').append(
                  '<div class="postthread-titlebar">' + 'Conversations' + '</div>'
                )

                if (process.platform != 'darwin') {
                  $('.postthread-titlebar').css({
                    paddingLeft: '12px',
                    textAlign: 'left',
                  })
                }

                $('.postthread, .postthread-titlebar').velocity(
                  {
                    marginTop: '0px',
                  },
                  {
                    duration: 250,
                    easing: 'easeOutCubic',
                  }
                )

                $('.postthread-close').velocity('fadeIn', {
                  duration: 500,
                  delay: 750,
                })
              }
            },
          })
        }

        $(document).on('click', '.postthread-close', closePostThread)

        ipcRenderer.on('token', (ev, msg) => {
          if (msg == null) {
            ipcRenderer.send('CreateAuthWindow')
          } else {
            token = msg

            getStream('stream')
            getStream('mentions')
            getStream('global')
            getInteractions()

            $.ajax({
              url: 'https://api.pnut.io/v0/users/me',
              type: 'GET',
              headers: { Authorization: 'Bearer ' + token },
              success: function (result) {
                $('#composeScreen .usericon').attr(
                  'src',
                  result.data.content.avatar_image.link
                )
                myUserId = result.data.id
                myUsername = result.data.username
              },
            })

            $.ajax({
              url: 'https://api.pnut.io/v0/token',
              type: 'GET',
              headers: { Authorization: 'Bearer ' + token },
              success: function (result) {
                if (result.data.storage.total == 0) {
                  $('#composeFileArea').hide()
                }
              },
            })
          }
          tabSelect(store.get('selectedTab', 0))
        })

        $(document).on('click', '.postReplyButton', function (e) {
          irtPostId = $(this).parents('.post').attr('post_id')
          var username = '@' + $(this).parents('.post').find('.username').text() + ' '

          if (
            $(this).parents('.postcontent').find('span[itemprop=mention]').length > 1
          ) {
            for (
              var i = 0;
              i <
              $(this).parents('.postcontent').find('span[itemprop=mention]').length;
              i++
            ) {
              var targetUsername = $(this)
                .parents('.postcontent')
                .find('span[itemprop=mention]:eq(' + i + ')')
                .attr('data-mention-name')
              if (myUsername != targetUsername) {
                username += '@' + targetUsername + ' '
              }
            }
          }

          if (e.shiftKey) {
            username = ''
          }
          openComposeScreen(username)
        })

        $(document).on('click', '.postStarButton', function () {
          var postId = $(this).parents('.post').attr('post_id')
          var requestType = 'PUT'

          $(this).removeClass('fa-star')
          $(this).addClass('fa-refresh fa-spin')

          if ($(this).parents('.post').hasClass('post-bookmarked')) {
            requestType = 'DELETE'
          }
          $.ajax({
            url: 'https://api.pnut.io/v0/posts/' + postId + '/bookmark',
            type: requestType,
            headers: { Authorization: 'Bearer ' + token },
            success: function (result) {
              $('.post[post_id=' + postId + '] .postStarButton').removeClass(
                'fa-refresh fa-spin'
              )
              $('.post[post_id=' + postId + '] .postStarButton').addClass('fa-star')
              if (requestType == 'DELETE') {
                $('.post[post_id=' + postId + ']').removeClass('post-bookmarked')
              } else {
                $('.post[post_id=' + postId + ']').addClass('post-bookmarked')
              }
            },
            error: function (result) {
              console.log(result)
              $('.post[post_id=' + postId + '] .postStarButton').removeClass(
                'fa-refresh fa-spin'
              )
              $('.post[post_id=' + postId + '] .postStarButton').addClass('fa-star')
            },
          })
        })

        $(document).on('click', '.postRepostButton', function () {
          var postId = $(this).parents('.post').attr('post_id')
          var requestType = 'PUT'

          $(this).removeClass('fa-retweet')
          $(this).addClass('fa-refresh fa-spin')

          if ($(this).parents('.post').hasClass('post-reposted')) {
            requestType = 'DELETE'
          }
          $.ajax({
            url: 'https://api.pnut.io/v0/posts/' + postId + '/repost',
            type: requestType,
            headers: { Authorization: 'Bearer ' + token },
            success: function (result) {
              $('.post[post_id=' + postId + '] .postRepostButton').removeClass(
                'fa-refresh fa-spin'
              )
              $('.post[post_id=' + postId + '] .postRepostButton').addClass(
                'fa-retweet'
              )
              if (requestType == 'DELETE') {
                $('.post[post_id=' + postId + ']').removeClass('post-reposted')
              } else {
                $('.post[post_id=' + postId + ']').addClass('post-reposted')
              }
            },
            error: function (result) {
              console.log(result)
              $('.post[post_id=' + postId + '] .postRepostButton').removeClass(
                'fa-refresh fa-spin'
              )
              $('.post[post_id=' + postId + '] .postRepostButton').addClass(
                'fa-retweet'
              )
            },
          })
        })

        $(document).on('click', '.postDeleteButton', function () {
          var dialogResult = confirm('really delete this post?')
          if (dialogResult) {
            var postId = $(this).parents('.post').attr('post_id')
            $.ajax({
              url: 'https://api.pnut.io/v0/posts/' + postId,
              type: 'DELETE',
              headers: { Authorization: 'Bearer ' + token },
              success: function (result) {
                $('.post[post_id=' + postId + ']').velocity('slideUp', {
                  complete: function () {
                    $('.post[post_id=' + postId + ']').remove()
                  },
                })
              },
            })
          } else {
          }
        })
      })

      function openComposeScreen(text) {
        if ($('#composeScreen').css('display') == 'none' || text !== undefined) {
          if ($('#composeScreen').css('display') == 'none') {
            $('#composeScreen').velocity('slideDown', { duration: 300 })
          }
          $('#composeTextArea').val(text)
          setTimeout(function () {
            $('#composeTextArea').focus()
          }, 320)
          $('#composeButton').css('color', '#fff')
          if ($('.postthread').length) {
            $('.postthread').velocity({
              marginTop: $('#composeScreen').outerHeight() + 'px',
            })
          }
        } else {
          closeComposeScreen()
        }

        if (irtPostId) {
          $.ajax({
            url: 'https://api.pnut.io/v0/posts/' + irtPostId,
            type: 'GET',
            headers: { Authorization: 'Bearer ' + token },
            success: function (result) {
              info = $(
                '<div id="composeScreenIrtInfo" style="display: none;"><span class="fa fa-reply"></span> ' +
                  result.data.user.username +
                  ': ' +
                  result.data.content.text +
                  '</div>'
              )
              $('#composeScreen').prepend(info)
              info.velocity('slideDown')
            },
          })
        }
      }

      function closeComposeScreen() {
        if ($('#composeTextArea').val()) {
          var dialogResult = confirm('Post will not saved. Really close?')
          if (dialogResult) {
          } else {
            return false
          }
        }

        $('#composeSpinner').velocity('fadeOut', { duration: 100 })
        $('#composeButton').css('color', '#bbb')
        $('#composeTextArea').val('')
        $('#composeTextArea').css('height', 'auto')
        $('#composeScreen').velocity('slideUp', { duration: 300 })
        $('#composeScreenIrtInfo').velocity('slideUp', {
          complete: $(this).remove(),
        })

        irtPostId = ''

        $('.postthread').velocity({ marginTop: '0px' })
      }

      $(document).on('drop dragover', 'body', function (event) {
        event.preventDefault()
      })

      $(document).on('dragover', '#composeScreen', function (event) {
        event.originalEvent.dataTransfer.dropEffect = 'copy'
      })

      $(document).on('drop', '#composeScreen', function (event) {
        event.preventDefault()
        if (event.originalEvent.dataTransfer.files[0].type.indexOf('image/') === 0) {
          document.getElementById('composeScreenFile').files =
            event.originalEvent.dataTransfer.files
        }
      })

      $(document).on('change', 'input[name="composeScreenFile"]', function (event) {
        uploadFilePreview(event.originalEvent.target.files[0])
      })

      $(document).on('click', '.composeScreenFilePreview', function () {
        var dialogResult = confirm('Remove this image?')
        if (dialogResult) {
          $(this).remove()
          uploadFile = null
          $('input[name="composeScreenFile"]').val('')
          $('#composeScreenFile').val()
          $("label[for='composeScreenFile']").velocity('fadeIn')
        }
      })

      function uploadFilePreview(file) {
        $("label[for='composeScreenFile']").velocity('fadeOut', {
          complete: function () {
            var img = $('<div class="composeScreenFilePreview">')
            img.css('background-image', 'url("' + file.path + '")')
            img.css({
              height: '20px',
              width: '24px',
              backgroundSize: 'cover',
              backgroundPosition: 'center center',
              cursor: 'pointer',
              float: 'left',
              marginRight: '5px',
            })
            img.appendTo('#composeFileArea')

            uploadFile = file
          },
        })
      }

      function composePost() {
        $('#composeSpinner').velocity('fadeIn', {
          complete: function () {
            var postData = {}

            if (uploadFile !== null) {
              var formData = new FormData()
              formData.append('type', 'tk.kyo5884.enuts')
              formData.append('name', $('#composeTextArea').val())
              formData.append('kind', 'image')
              formData.append('content', uploadFile)

              $.ajax({
                url: 'https://api.pnut.io/v0/files',
                type: 'POST',
                async: false,
                contentType: false,
                processData: false,
                headers: { Authorization: 'Bearer ' + token },
                data: formData,
                success: function (result) {
                  console.log('fileupload', result)

                  postData = {
                    raw: [
                      {
                        type: 'io.pnut.core.oembed',
                        value: {
                          '+io.pnut.core.file': {
                            file_id: result.data.id,
                            file_token: result.data.file_token,
                            format: 'oembed',
                          },
                        },
                      },
                    ],
                  }

                  $('.composeScreenFilePreview').remove()
                  uploadFile = null
                  $('#composeScreenFile').val()
                  $("label[for='composeScreenFile']").velocity('fadeIn')
                },
                error: function (result) {
                  console.log('fileupload', result)
                  return
                },
              })
            }

            if (irtPostId) {
              postData['reply_to'] = irtPostId
            }

            postData['text'] = $('#composeTextArea').val()
            postData['update_marker'] = 1

            $.ajax({
              url: 'https://api.pnut.io/v0/posts?include_post_raw=1',
              type: 'POST',
              async: false,
              headers: { Authorization: 'Bearer ' + token },
              data: postData,
              success: function (result) {
                console.log(result)
                $('#composeTextArea').val('')
                $('#composeCharRemain').text('256')
                closeComposeScreen()
                getStream('stream')
                getStream('global')
                irtPostId = ''

                postData = null
              },
              error: function (result) {
                console.log(result)
                alert($.parseJSON(result.responseText).meta.error_message)
                $('#composeSpinner').velocity('fadeOut')

                postData = null
              },
            })
          },
        })
      }

      function getStream(type) {
        var typeUrl
        var latestId
        var includeDirectedPosts

        console.log('getting stream: ' + type)

        switch (type) {
          case 'stream':
            if (loading_stream) return false
            typeUrl = 'https://api.pnut.io/v0/posts/streams/me'
            latestId = latestStreamPostId
            if (store.get('includeDirectedPosts', false)) {
              includeDirectedPosts = 1
            } else {
              includeDirectedPosts = 0
            }
            loading_stream = true
            break
          case 'global':
            if (loading_global) return false
            typeUrl = 'https://api.pnut.io/v0/posts/streams/global'
            latestId = latestGlobalPostId
            includeDirectedPosts = 1
            loading_global = true
            break
          case 'mentions':
            if (loading_mentions) return false
            typeUrl = 'https://api.pnut.io/v0/users/me/mentions'
            latestId = latestMentionsPostId
            includeDirectedPosts = 1
            loading_mentions = true
            break
        }

        $.ajax({
          url: typeUrl,
          type: 'GET',
          headers: { Authorization: 'Bearer ' + token },
          data: {
            //since_id: latestId,
            count: 200,
            include_directed_posts: includeDirectedPosts,
            include_copy_mentions: 1,
            include_post_raw: 1,
          },
          success: function (result) {
            console.log(type, result)
            var prependHTML = ''
            if (result.data.length) {
              switch (type) {
                case 'stream':
                  latestStreamPostId = parseInt(result.data[0].id)
                  break
                case 'global':
                  latestGlobalPostId = parseInt(result.data[0].id)
                  break
                case 'mentions':
                  latestMentionsPostId = parseInt(result.data[0].id)
                  break
              }

              for (var i in result.data) {
                if (result.data[i].is_deleted) {
                  $('.post[post_id=' + result.data[i].id + ']').velocity('slideUp')
                } else if (result.data[i].id > latestId) {
                  var postDate = new Date(result.data[i].created_at).toLocaleString()
                  var postRelativeDate = getRelativeDate(postDate)
                  var postImage = ''
                  var repostInfo = ''
                  var displayname = ''

                  var deleteButton,
                    postclass = ''

                  if ('repost_of' in result.data[i]) {
                    repostInfo =
                      ' <span class="repostedUsername"><span class="fa fa-retweet"></span> ' +
                      result.data[i].user.username +
                      '</span>'

                    result.data[i] = result.data[i].repost_of
                  }

                  if (result.data[i].user.id == myUserId) {
                    postclass = postclass + ' post-mypost'
                  } else {
                    deleteButton = ''
                  }

                  if (result.data[i].you_bookmarked) {
                    postclass = postclass + ' post-bookmarked'
                  }

                  if (result.data[i].you_reposted) {
                    postclass = postclass + ' post-reposted'
                  }

                  if (result.data[i].user.name != undefined) {
                    displayname =
                      '<span class="displayname">' +
                      result.data[i].user.name +
                      '</span>'
                  }

                  if ('raw' in result.data[i]) {
                    if (result.data[i].raw.length) {
                      for (var j in result.data[i].raw) {
                        if (result.data[i].raw[j].value.type == 'photo') {
                          var imgUrl = result.data[i].raw[j].value.url
                          if (imgUrl.startsWith('http')) {
                            postImage =
                              postImage +
                              '<a href="' +
                              imgUrl +
                              '"><img class="postimage" src="' +
                              imgUrl +
                              '"></a><br>'
                          }
                        }
                      }
                    }
                  }
                  if (result.data[i].content.entities.links.length) {
                    for (var j in result.data[i].content.entities.links) {
                      var url = result.data[i].content.entities.links[j].link
                      if (
                        url.match(/.*\.png|.*\.jpeg|.*\.jpg|.*\.gif/) &&
                        url.startsWith('http')
                      ) {
                        postImage =
                          postImage +
                          '<a href="' +
                          url +
                          '"><img class="postimage" src="' +
                          url +
                          '"></a><br>'
                      }
                    }
                  }

                  for (var j in result.data[i].content.entities.mentions) {
                    if (result.data[i].content.entities.mentions[j].id == myUserId) {
                      if (type != 'mentions') {
                        postclass = postclass + ' post-mentioned-me'
                      }
                    }
                  }

                  // $(".post-latest").removeClass("post-latest");

                  prependHTML =
                    prependHTML +
                    '<div class="post post-latest' +
                    postclass +
                    '" post_id=' +
                    result.data[i].id +
                    ' post_created_at="' +
                    result.data[i].created_at +
                    '">' +
                    '<img class="usericon" src="' +
                    result.data[i].user.content.avatar_image.link +
                    '">' +
                    '<div class="postcontent">' +
                    '<div class="usernameArea">' +
                    '<span class="username">' +
                    result.data[i].user.username +
                    '</span> ' +
                    displayname +
                    repostInfo +
                    '</div>' +
                    '<div class="postdate">' +
                    '<span class="postDateText"><span class="postRelDateText">' +
                    postRelativeDate +
                    '</span></span>' +
                    '<div class="postcontrol">' +
                    '<span class="fa fa-reply fa-fw postReplyButton"></span>' +
                    '<span class="fa fa-star fa-fw postStarButton"></span>' +
                    '<span class="fa fa-retweet fa-fw postRepostButton"></span>' +
                    '<span class="fa fa-trash-o fa-fw postDeleteButton"></span>' +
                    '<span class="fa fa-ellipsis-h fa-fw postDetailButton"></span>' +
                    '</div>' +
                    '</div>' +
                    '<div class="posttext">' +
                    result.data[i].content.html +
                    '</div>' +
                    postImage +
                    '</div>' +
                    '</div>'

                  if (
                    type == 'stream' &&
                    store.get('notifyStream', false) &&
                    latestId != 0 &&
                    result.data[i].user.id != myUserId
                  ) {
                    notify(
                      'New post from @' + result.data[i].user.username,
                      result.data[i].content.text,
                      function () {
                        tabSelect(0)
                      }
                    )
                  }

                  if (
                    type == 'mentions' &&
                    store.get('notifyMentions', true) &&
                    latestId != 0 &&
                    result.data[i].user.id != myUserId
                  ) {
                    notify(
                      'Mention from @' + result.data[i].user.username,
                      result.data[i].content.text,
                      function () {
                        tabSelect(1)
                      }
                    )
                  }

                  if (
                    type == 'global' &&
                    store.get('notifyGlobal', false) &&
                    latestId != 0 &&
                    result.data[i].user.id != myUserId
                  ) {
                    notify(
                      'New global post from @' + result.data[i].user.username,
                      result.data[i].content.text,
                      function () {
                        tabSelect(3)
                      }
                    )
                  }
                }
              }

              $('#' + type).prepend(prependHTML)

              $('#streamSpinner').velocity('fadeOut', { duration: 300 })

              var scrPos = $('#' + type).scrollTop()
              if (scrPos > 0 || $('#' + type).css('display') == 'none') {
                if ($('#' + type + ' .post-latest').length && latestId != 0) {
                  $('#' + type).scrollTop(
                    scrPos + $('#' + type + ' .post-latest').outerHeight()
                  )

                  if (type == 'stream' && store.get('streamUnreadIndicator', true)) {
                    $('#streamButton').addClass('unread-indicator')
                  }
                  if (
                    type == 'mentions' &&
                    store.get('mentionsUnreadIndicator', true)
                  ) {
                    $('#mentionsButton').addClass('unread-indicator')
                  }
                  if (type == 'global' && store.get('globalUnreadIndicator', false)) {
                    $('#globalButton').addClass('unread-indicator')
                  }
                }
              } else {
                $('#' + type).scrollTop($('#' + type + ' .post-latest').outerHeight())
                $('#' + type).animate({ scrollTop: 0 })
              }

              $('#' + type + ' .post-latest').removeClass('post-latest')

              //$("#" + type + " .post:gt(200)").remove();
            }
          },
          error: function (result) {
            console.log(result)
          },
          complete: function () {
            loading_global = false
            loading_stream = false
            loading_mentions = false
          },
        })
      }

      function getProfile(user) {
        $('#profileStream').empty()
        $('#profileBookmarks').empty()
        $('#profileFollowing').empty()
        $('#profileFollowers').empty()

        $('#profile').removeClass('profile-you-follow')
        $('#profile').removeClass('profile-you-not-follow')
        $('#profile').removeClass('profile-you-blocked')
        $('#profile').removeClass('profile-you-muted')
        $('#profileFollowsYouLabel').hide()
        $('#profileMutedLabel').hide()

        $('#profileOptionMenu').css('transform', 'translateX(100%)')
        $('#profileBlockButton').show()
        $('#profileMuteButton').show()

        $('#profileHeaderImage').css('background-image', 'none')
        $('#profileAvatar').attr('src', '')

        $('#profileDisplayname').text('')
        $('#profileUsername').text('')

        $('#profileBio').text('')

        $('#profileFollowingCount').text('')
        $('#profileFollowersCount').text('')
        $('#profilePostsCount').text('')

        $('.profile-tab').hide()
        $('#profileCounts div').removeClass('profile-counts-selected')
        $('#profileStream').show()
        $('#profilePostsButton').addClass('profile-counts-selected')

        $.ajax({
          url: 'https://api.pnut.io/v0/users/' + user,
          type: 'GET',
          headers: { Authorization: 'Bearer ' + token },
          success: function (result) {
            console.log('user', result)

            $('#profileHeaderImage').css(
              'background-image',
              'url(' + result.data.content.cover_image.link + ')'
            )
            $('#profileAvatar').attr('src', result.data.content.avatar_image.link)

            if (result.data.name != undefined) {
              $('#profileDisplayname').text(result.data.name)
            } else {
              $('#profileDisplayname').text(result.data.username)
            }

            $('#profileUsername').text('@' + result.data.username)

            $('#profileBio').html(result.data.content.html)

            if (user == 'me') {
              $('#profile').addClass('profile-you-follow')
              $('#profileFollowButton').html(
                '<span class="fa fa-check-circle"></span> This is you!'
              )
              $('#profileBlockButton').hide()
              $('#profileMuteButton').hide()
              $('#profileEditButton').show()
            } else {
              $('#profileEditButton').hide()
              if (result.data.you_follow) {
                $('#profile').addClass('profile-you-follow')
                $('#profileFollowButton').html(
                  '<span class="fa fa-check-circle"></span> Following'
                )
              } else {
                if (result.data.you_blocked) {
                  $('#profile').addClass('profile-you-blocked')
                  $('#profileFollowButton').html(
                    '<span class="fa fa-ban"></span> Blocked'
                  )
                  $('#profileBlockButton').html(
                    '<span class="fa fa-ban"></span> Unblock'
                  )
                } else {
                  $('#profileBlockButton').html(
                    '<span class="fa fa-ban"></span> Block'
                  )
                  $('#profile').addClass('profile-you-not-follow')
                  $('#profileFollowButton').html(
                    '<span class="fa fa-user-plus"></span> Follow'
                  )
                }
              }

              if (result.data.follows_you) {
                $('#profileFollowsYouLabel').show()
              }

              if (result.data.you_muted) {
                $('#profile').addClass('profile-you-muted')
                $('#profileMuteButton').html(
                  '<span class="fa fa-eye-slash"></span> Unmute'
                )
                $('#profileMutedLabel').show()
              } else {
                $('#profileMuteButton').html(
                  '<span class="fa fa-eye-slash"></span> Mute'
                )
              }
            }

            $('#profileFollowingCount').text(result.data.counts.following)
            $('#profileFollowersCount').text(result.data.counts.followers)
            $('#profilePostsCount').text(result.data.counts.posts)
            $('#profileBookmarksCount').text(result.data.counts.bookmarks)
          },
        })

        $.ajax({
          url: 'https://api.pnut.io/v0/users/' + user + '/posts',
          type: 'GET',
          headers: { Authorization: 'Bearer ' + token },
          data: {
            count: 200,
            include_post_raw: 1,
          },
          success: function (result) {
            console.log('userposts', result)

            if (result.data.length) {
              var prependHTML = ''
              for (var i in result.data) {
                if (!result.data[i].is_deleted) {
                  var postDate = new Date(result.data[i].created_at).toLocaleString()
                  var postRelativeDate = getRelativeDate(postDate)
                  var postImage = ''
                  var repostInfo = ''
                  var displayname = ''

                  var deleteButton,
                    postclass = ''

                  if ('repost_of' in result.data[i]) {
                    repostInfo =
                      ' <span class="repostedUsername"><span class="fa fa-retweet"></span> ' +
                      result.data[i].user.username +
                      '</span>'

                    result.data[i] = result.data[i].repost_of
                  }

                  if (result.data[i].user.id == myUserId) {
                    postclass = postclass + ' post-mypost'
                  } else {
                    deleteButton = ''
                  }

                  if (result.data[i].you_bookmarked) {
                    postclass = postclass + ' post-bookmarked'
                  }

                  if (result.data[i].you_reposted) {
                    postclass = postclass + ' post-reposted'
                  }

                  if (result.data[i].user.name != undefined) {
                    displayname =
                      '<span class="displayname">' +
                      result.data[i].user.name +
                      '</span>'
                  }

                  if ('raw' in result.data[i]) {
                    if (result.data[i].raw.length) {
                      for (var j in result.data[i].raw) {
                        if (result.data[i].raw[j].value.type == 'photo') {
                          var imgUrl = result.data[i].raw[j].value.url
                          if (imgUrl.startsWith('http')) {
                            postImage =
                              postImage +
                              '<a href="' +
                              imgUrl +
                              '"><img class="postimage" src="' +
                              imgUrl +
                              '"></a><br>'
                          }
                        }
                      }
                    }
                  }
                  if (result.data[i].content.entities.links.length) {
                    for (var j in result.data[i].content.entities.links) {
                      var url = result.data[i].content.entities.links[j].link
                      if (
                        url.match(/.*\.png|.*\.jpeg|.*\.jpg|.*\.gif/) &&
                        url.startsWith('http')
                      ) {
                        postImage =
                          postImage +
                          '<a href="' +
                          url +
                          '"><img class="postimage" src="' +
                          url +
                          '"></a><br>'
                      }
                    }
                  }

                  $('.post-latest').removeClass('post-latest')

                  prependHTML =
                    prependHTML +
                    '<div class="post post-latest' +
                    postclass +
                    '" post_id=' +
                    result.data[i].id +
                    ' post_created_at="' +
                    result.data[i].created_at +
                    '" style="display: none;">' +
                    '<img class="usericon" src="' +
                    result.data[i].user.content.avatar_image.link +
                    '">' +
                    '<div class="postcontent">' +
                    '<div class="usernameArea">' +
                    '<span class="username">' +
                    result.data[i].user.username +
                    '</span> ' +
                    displayname +
                    repostInfo +
                    '</div>' +
                    '<div class="postdate">' +
                    '<span class="postDateText"><span class="postRelDateText">' +
                    postRelativeDate +
                    '</span></span>' +
                    '<div class="postcontrol">' +
                    '<span class="fa fa-reply fa-fw postReplyButton"></span>' +
                    '<span class="fa fa-star fa-fw postStarButton"></span>' +
                    '<span class="fa fa-retweet fa-fw postRepostButton"></span>' +
                    '<span class="fa fa-trash-o fa-fw postDeleteButton"></span>' +
                    '<span class="fa fa-ellipsis-h fa-fw postDetailButton"></span>' +
                    '</div>' +
                    '</div>' +
                    '<div class="posttext">' +
                    result.data[i].content.html +
                    '</div>' +
                    postImage +
                    '</div>' +
                    '</div>'
                }
              }

              $('#profileStream').prepend(prependHTML)
              $('.post-latest').velocity('slideDown', {
                duration: 300,
                delay: 300,
              })
            }
          },
        })

        $.ajax({
          url: 'https://api.pnut.io/v0/users/' + user + '/bookmarks',
          type: 'GET',
          headers: { Authorization: 'Bearer ' + token },
          data: {
            include_post_raw: 1,
            count: 200,
          },
          success: function (result) {
            console.log('userbookmarks', result)

            if (result.data.length) {
              var prependHTML = ''
              for (var i in result.data) {
                if (!result.data[i].is_deleted) {
                  var postDate = new Date(result.data[i].created_at).toLocaleString()
                  var postRelativeDate = getRelativeDate(postDate)
                  var postImage = ''
                  var repostInfo = ''
                  var displayname = ''

                  var deleteButton,
                    postclass = ''

                  if ('repost_of' in result.data[i]) {
                    repostInfo =
                      ' <span class="repostedUsername"><span class="fa fa-retweet"></span> ' +
                      result.data[i].user.username +
                      '</span>'

                    result.data[i] = result.data[i].repost_of
                  }

                  if (result.data[i].user.id == myUserId) {
                    postclass = postclass + ' post-mypost'
                  } else {
                    deleteButton = ''
                  }

                  if (result.data[i].you_bookmarked) {
                    postclass = postclass + ' post-bookmarked'
                  }

                  if (result.data[i].you_reposted) {
                    postclass = postclass + ' post-reposted'
                  }

                  if (result.data[i].user.name != undefined) {
                    displayname =
                      '<span class="displayname">' +
                      result.data[i].user.name +
                      '</span>'
                  }

                  if ('raw' in result.data[i]) {
                    if (result.data[i].raw.length) {
                      for (var j in result.data[i].raw) {
                        if (result.data[i].raw[j].value.type == 'photo') {
                          var imgUrl = result.data[i].raw[j].value.url
                          if (imgUrl.startsWith('http')) {
                            postImage =
                              postImage +
                              '<a href="' +
                              imgUrl +
                              '"><img class="postimage" src="' +
                              imgUrl +
                              '"></a><br>'
                          }
                        }
                      }
                    }
                  }
                  if (result.data[i].content.entities.links.length) {
                    for (var j in result.data[i].content.entities.links) {
                      var url = result.data[i].content.entities.links[j].link
                      if (
                        url.match(/.*\.png|.*\.jpeg|.*\.jpg|.*\.gif/) &&
                        url.startsWith('http')
                      ) {
                        postImage =
                          postImage +
                          '<a href="' +
                          url +
                          '"><img class="postimage" src="' +
                          url +
                          '"></a><br>'
                      }
                    }
                  }

                  $('.post-latest').removeClass('post-latest')

                  prependHTML =
                    prependHTML +
                    '<div class="post post-latest' +
                    postclass +
                    '" post_id=' +
                    result.data[i].id +
                    ' post_created_at="' +
                    result.data[i].created_at +
                    '" style="display: none;">' +
                    '<img class="usericon" src="' +
                    result.data[i].user.content.avatar_image.link +
                    '">' +
                    '<div class="postcontent">' +
                    '<div class="usernameArea">' +
                    '<span class="username">' +
                    result.data[i].user.username +
                    '</span> ' +
                    displayname +
                    repostInfo +
                    '</div>' +
                    '<div class="postdate">' +
                    '<span class="postDateText"><span class="postRelDateText">' +
                    postRelativeDate +
                    '</span></span>' +
                    '<div class="postcontrol">' +
                    '<span class="fa fa-reply fa-fw postReplyButton"></span>' +
                    '<span class="fa fa-star fa-fw postStarButton"></span>' +
                    '<span class="fa fa-retweet fa-fw postRepostButton"></span>' +
                    '<span class="fa fa-trash-o fa-fw postDeleteButton"></span>' +
                    '<span class="fa fa-ellipsis-h fa-fw postDetailButton"></span>' +
                    '</div>' +
                    '</div>' +
                    '<div class="posttext">' +
                    result.data[i].content.html +
                    '</div>' +
                    postImage +
                    '</div>' +
                    '</div>'
                }
              }

              $('#profileBookmarks').prepend(prependHTML)
              $('.post-latest').velocity('slideDown', {
                duration: 300,
                delay: 300,
              })
            }
          },
        })

        $.ajax({
          url: 'https://api.pnut.io/v0/users/' + user + '/followers',
          type: 'GET',
          headers: { Authorization: 'Bearer ' + token },
          data: { count: 200 },
          success: function (result) {
            console.log('userfollowers', result)

            if (result.data.length) {
              var prependHTML = ''

              for (var i in result.data) {
                var followsYou = ''
                var profileBio = ''

                if (result.data[i].follows_you) {
                  followsYou = ' Follows You '
                }

                if (result.data[i].name == undefined) {
                  result.data[i].name = ''
                }

                if (result.data[i].content.text == undefined) {
                  profileBio = ''
                } else {
                  profileBio =
                    '<p class="profileBio">' + result.data[i].content.text + '</p>'
                }

                prependHTML =
                  prependHTML +
                  '<div class="post">' +
                  '<img class="usericon" src="' +
                  result.data[i].content.avatar_image.link +
                  '">' +
                  '<div class="postcontent">' +
                  '<div class="usernameArea">' +
                  '<span class="username">' +
                  result.data[i].username +
                  '</span> ' +
                  '<span class="displayname">' +
                  result.data[i].name +
                  '</span><br>' +
                  '</div>' +
                  '<div class="postdate">' +
                  '<span class="">' +
                  followsYou +
                  '</span>' +
                  '</div>' +
                  '<div class="posttext">' +
                  '<p>' +
                  '<span class="fa fa-comment"></span> ' +
                  result.data[i].counts.posts +
                  ' <span class="fa fa-user-circle-o"></span><span class="fa fa-arrow-circle-right" style="font-size: 10pt; margin-left: -3px;"></span>' +
                  result.data[i].counts.following +
                  ' <span class="fa fa-user-circle-o"></span><span class="fa fa-arrow-circle-left" style="font-size: 10pt; margin-left: -3px;"></span>' +
                  result.data[i].counts.followers +
                  '<br>' +
                  '</p>' +
                  profileBio +
                  '</div>' +
                  '</div>' +
                  '</div>'
              }

              $('#profileFollowers').prepend(prependHTML)
            }
          },
        })

        $.ajax({
          url: 'https://api.pnut.io/v0/users/' + user + '/following',
          type: 'GET',
          headers: { Authorization: 'Bearer ' + token },
          data: { count: 200 },
          success: function (result) {
            console.log('userfollowing', result)

            if (result.data.length) {
              var prependHTML = ''

              for (var i in result.data) {
                var followsYou = ''
                var profileBio = ''

                if (result.data[i].follows_you) {
                  followsYou = ' Follows You '
                }

                if (result.data[i].name == undefined) {
                  result.data[i].name = ''
                }

                if (result.data[i].content.text == undefined) {
                  profileBio = ''
                } else {
                  profileBio =
                    '<p class="profileBio">' + result.data[i].content.text + '</p>'
                }

                prependHTML =
                  prependHTML +
                  '<div class="post">' +
                  '<img class="usericon" src="' +
                  result.data[i].content.avatar_image.link +
                  '">' +
                  '<div class="postcontent">' +
                  '<div class="usernameArea">' +
                  '<span class="username">' +
                  result.data[i].username +
                  '</span> ' +
                  '<span class="displayname">' +
                  result.data[i].name +
                  '</span><br>' +
                  '</div>' +
                  '<div class="postdate">' +
                  '<span class="">' +
                  followsYou +
                  '</span>' +
                  '</div>' +
                  '<div class="posttext">' +
                  '<p>' +
                  '<span class="fa fa-comment"></span> ' +
                  result.data[i].counts.posts +
                  ' <span class="fa fa-user-circle-o"></span><span class="fa fa-arrow-circle-right" style="font-size: 10pt; margin-left: -3px;"></span>' +
                  result.data[i].counts.following +
                  ' <span class="fa fa-user-circle-o"></span><span class="fa fa-arrow-circle-left" style="font-size: 10pt; margin-left: -3px;"></span>' +
                  result.data[i].counts.followers +
                  '<br>' +
                  '</p>' +
                  profileBio +
                  '</div>' +
                  '</div>' +
                  '</div>'
              }

              $('#profileFollowing').prepend(prependHTML)
            }
          },
        })
      }

      $(document).on(
        'click',
        '#profileOptionButton, #profileMutedLabel',
        function () {
          profileOptionOpen()
        }
      )

      $(document).on('click', '#profileOptionCloseButton', function () {
        profileOptionClose()
      })

      $(document).on('click', '#profileFollowButton', function () {
        if ($('#profile').hasClass('profile-you-blocked')) {
          profileOptionOpen()
        } else {
          var userId = $('#profileUsername').text()
          var action = 'PUT'
          if ($('#profile').hasClass('profile-you-not-follow')) {
            action = 'PUT'
          } else {
            action = 'DELETE'
          }

          $.ajax({
            url: 'https://api.pnut.io/v0/users/' + userId + '/follow',
            type: action,
            headers: { Authorization: 'Bearer ' + token },
            success: function (result) {
              console.log('follow', result)
              if (action == 'PUT') {
                $('#profile').removeClass('profile-you-not-follow')
                $('#profile').addClass('profile-you-follow')
                $('#profileFollowButton').html(
                  '<span class="fa fa-check-circle"></span> Following'
                )
              } else {
                $('#profile').removeClass('profile-you-follow')
                $('#profile').addClass('profile-you-not-follow')
                $('#profileFollowButton').html(
                  '<span class="fa fa-user-plus"></span> Follow'
                )
              }
            },
          })
        }
      })

      $(document).on('click', '#profileEditButton', function () {
        ipcRenderer.send('openConfig')
      })

      $(document).on('click', '#profileMuteButton', function () {
        var userId = $('#profileUsername').text()
        var action = 'PUT'
        if ($('#profile').hasClass('profile-you-muted')) {
          action = 'DELETE'
        } else {
          action = 'PUT'
        }

        $.ajax({
          url: 'https://api.pnut.io/v0/users/' + userId + '/mute',
          type: action,
          headers: { Authorization: 'Bearer ' + token },
          success: function (result) {
            console.log('mute', result)
            if (action == 'PUT') {
              $('#profile').addClass('profile-you-muted')
              $('#profileMuteButton').html(
                '<span class="fa fa-eye-slash"></span> Unmute'
              )
              $('#profileMutedLabel').show()
            } else {
              $('#profile').removeClass('profile-you-muted')
              $('#profileMuteButton').html(
                '<span class="fa fa-eye-slash"></span> Mute'
              )
              $('#profileMutedLabel').hide()
            }

            profileOptionClose()
          },
        })
      })

      $(document).on('click', '#profileBlockButton', function () {
        var userId = $('#profileUsername').text()
        var action = 'PUT'
        if ($('#profile').hasClass('profile-you-blocked')) {
          action = 'DELETE'
        } else {
          action = 'PUT'
        }

        $.ajax({
          url: 'https://api.pnut.io/v0/users/' + userId + '/block',
          type: action,
          headers: { Authorization: 'Bearer ' + token },
          success: function (result) {
            console.log('block', result)
            if (action == 'PUT') {
              $('#profile').removeClass('profile-you-follow')
              $('#profile').removeClass('profile-you-not-follow')
              $('#profile').addClass('profile-you-blocked')
              $('#profileFollowsYouLabel').hide()
              $('#profileBlockButton').html('<span class="fa fa-ban"></span> Unblock')
              $('#profileFollowButton').html(
                '<span class="fa fa-ban"></span> Blocked'
              )
            } else {
              $('#profile').removeClass('profile-you-blocked')
              $('#profile').addClass('profile-you-not-follow')
              $('#profileBlockButton').html('<span class="fa fa-ban"></span> Block')
              $('#profileFollowButton').html(
                '<span class="fa fa-user-plus"></span> Follow'
              )
            }

            profileOptionClose()
          },
        })
      })

      $(document).on('click', '#profileOpenWebButton', function () {
        shell.openExternal('http://pnut.io/' + $('#profileUsername').text())
        profileOptionClose()
      })

      function profileOptionOpen() {
        $('#profileOptionMenu').velocity(
          { translateX: ['0%', '100%'], opacity: [1, 0] },
          { easing: 'easeOutQuint', duration: '500' }
        )
      }
      function profileOptionClose() {
        $('#profileOptionMenu').velocity(
          { translateX: ['100%', '0%'], opacity: [0, 1] },
          { easing: 'easeOutQuint', duration: '500' }
        )
      }

      $(document).on('click', '#profileCounts div', function () {
        $('#profileCounts div').removeClass('profile-counts-selected')
        $(this).addClass('profile-counts-selected')
      })

      $(document).on('click', '#profileBookmarksButton', function () {
        $('.profile-tab').hide()
        $('#profileBookmarks').show()
      })

      $(document).on('click', '#profileFollowingButton', function () {
        $('.profile-tab').hide()
        $('#profileFollowing').show()
      })

      $(document).on('click', '#profileFollowersButton', function () {
        $('.profile-tab').hide()
        $('#profileFollowers').show()
      })

      $(document).on('click', '#profilePostsButton', function () {
        $('.profile-tab').hide()
        $('#profileStream').show()
      })

      function tabSelect(tabId, userTabUser) {
        if (selectedTab != tabId || userTabUser !== undefined) {
          selectedTab = tabId
          store.set('selectedTab', tabId)

          $('#titlebar-center .titlebar-button').css('color', '#bbb')
          $('#titlebar-center .titlebar-button:eq(' + tabId + ')').css(
            'color',
            '#fff'
          )

          $('.streams').velocity('fadeOut', { duration: 250 })
          closePostThread()

          switch (tabId) {
            case 0:
              $('#stream').velocity('fadeIn', { duration: 250 })
              if ($('#stream').scrollTop() == 0) {
                $('#streamButton').removeClass('unread-indicator')
              }
              break
            case 1:
              $('#mentions').velocity('fadeIn', { duration: 250 })
              if ($('#mentions').scrollTop() == 0) {
                $('#mentionsButton').removeClass('unread-indicator')
              }
              break
            case 2:
              $('#interactions').velocity('fadeIn', { duration: 250 })
              if ($('#interactions').scrollTop() == 0) {
                $('#interactionsButton').removeClass('unread-indicator')
              }
              break
            case 3:
              $('#global').velocity('fadeIn', { duration: 250 })
              if ($('#global').scrollTop() == 0) {
                $('#globalButton').removeClass('unread-indicator')
              }
              break
            case 5:
              $('#search').velocity('fadeIn', { duration: 250 })
              $('#searchInput').focus()
              break

            case 4:
              if (userTabUser === undefined) {
                userTabUser = 'me'
              }

              getProfile(userTabUser)
              $('#profile').velocity('fadeIn', { duration: 250 })
              $('#titlebar').velocity(
                { backgroundColor: '#000000', backgroundColorAlpha: 0 },
                { duration: 1000, easing: 'easeOutQuint' }
              )
              $('#titlebar').addClass('titlebar-profiletab')
              break
          }

          if (tabId != 4) {
            if (process.platform == 'darwin') {
              $('#titlebar').velocity({
                backgroundColor: '#000000',
                backgroundColorAlpha: 0.3,
              })
            } else {
              $('#titlebar').velocity({
                backgroundColor: '#000000',
                backgroundColorAlpha: 1.0,
              })
            }
            $('#titlebar').removeClass('titlebar-profiletab')
          }
        } else {
          if (tabId == 4 && $('.streams').scrollTop() == 0) {
            getProfile('me')
          } else {
            $('.streams').animate({ scrollTop: 0 })
          }
        }
      }

      function getInteractions() {
        console.log('getting interactions')
        if (loading_interactions) return false
        loading_interactions = true
        $.ajax({
          url: 'https://api.pnut.io/v0/users/me/interactions',
          type: 'GET',
          headers: { Authorization: 'Bearer ' + token },
          data: {
            since_id: latestInteractionsId,
            count: 200,
            include_post_raw: 1,
            filters: 'bookmark,repost,follow',
          },
          success: function (result) {
            var prependHTML = ''

            console.log('interactions', result)

            if (result.data.length) {
              for (var i in result.data) {
                var postDate = new Date(result.data[i].event_date).toLocaleString()
                var postRelativeDate = getRelativeDate(postDate)
                var content
                var action
                var post_id

                switch (result.data[i].action) {
                  case 'bookmark':
                    action = '<span class="fa fa-star"></span> Bookmarked'
                    post_id = result.data[i].objects[0].id

                    if (result.data[i].objects[0].is_deleted) {
                      content =
                        '<div class="posttext" style="font-style: italic;">This post was deleted.</div>'
                    } else {
                      content =
                        '<div class="posttext">' +
                        result.data[i].objects[0].content.html +
                        '</div>'
                      if (
                        store.get('notifyInteractions', true) &&
                        latestInteractionsId != 0
                      ) {
                        notify(
                          'Bookmarked by @' + result.data[i].users[0].username,
                          result.data[i].objects[0].content.text,
                          function () {
                            tabSelect(2)
                          }
                        )
                      }
                    }

                    break
                  case 'repost':
                    action = '<span class="fa fa-retweet"></span> Reposted'
                    post_id = result.data[i].objects[0].id

                    if (result.data[i].objects[0].is_deleted) {
                      content =
                        '<div class="posttext" style="font-style: italic;">This post was deleted.</div>'
                    } else {
                      content =
                        '<div class="posttext">' +
                        result.data[i].objects[0].content.html +
                        '</div>'
                      if (
                        store.get('notifyInteractions', true) &&
                        latestInteractionsId != 0
                      ) {
                        notify(
                          'Reposted by @' + result.data[i].users[0].username,
                          result.data[i].objects[0].content.text,
                          function () {
                            tabSelect(2)
                          }
                        )
                      }
                    }

                    break
                  case 'follow':
                    action = '<span class="fa fa-user-plus"></span> Followed'
                    content = ''

                    if (
                      store.get('notifyInteractions', true) &&
                      latestInteractionsId != 0
                    ) {
                      notify(
                        'Followed by @' + result.data[i].users[0].username,
                        '',
                        function () {
                          tabSelect(2)
                        }
                      )
                    }
                    break
                  default:
                    action = result.data[i].action
                    break
                }
                prependHTML =
                  prependHTML +
                  '<div class="post post-interaction post-latest"' +
                  ' post_id="' +
                  post_id +
                  '" post_created_at="' +
                  result.data[i].event_date +
                  '">' +
                  '<img class="usericon" src="' +
                  result.data[i].users[0].content.avatar_image.link +
                  '">' +
                  '<div class="postcontent">' +
                  '<div class="usernameArea">' +
                  action +
                  ' by <span class="username">' +
                  result.data[i].users[0].username +
                  '</span>' +
                  '</div>' +
                  '<div class="postdate">' +
                  '<span class="postRelDateText">' +
                  postRelativeDate +
                  '</span>' +
                  '</div>' +
                  content +
                  '</div>' +
                  '</div>'
              }

              $('#interactions').prepend(prependHTML)

              var scrPos = $('#interactions').scrollTop()
              if (scrPos > 0 || $('#interactions').css('display') == 'none') {
                if (
                  $('#interactions .post-latest').length &&
                  latestInteractionsId != 0
                ) {
                  $('#interactions').scrollTop(
                    scrPos + $('#interactions .post-latest').outerHeight()
                  )

                  if (store.get('unreadIndicatorInteractions', true)) {
                    $('#interactionsButton').addClass('unread-indicator')
                  }
                }
              } else {
                $('#interactions').scrollTop(
                  $('#interactions .post-latest').outerHeight()
                )
                $('#interactions').animate({ scrollTop: 0 })
              }

              $('#interactions .post-latest').removeClass('post-latest')
              latestInteractionsId = result.data[0].pagination_id
            }
          },
          complete: function () {
            loading_interactions = false
          },
        })
      }

      $(document).on('click', 'span[itemprop=tag]', function () {
        search($(this).text(), 'tag', 'id')
        $('#searchButton').velocity('fadeOut')
        $('#searchClearButton').velocity('fadeIn')
        $('select[name="searchTypeSelect"]').val('tag')
        $('#searchInput').val($(this).text().substr(1))
        tabSelect(5)
      })

      function search(query, type, sort) {
        if (query.startsWith('#')) {
          query = query.substr(1)
        }

        if (query.length) {
          if (sort === undefined) {
            sort = 'id'
          }
          if (type === undefined) {
            type = 'keyword'
          }

          var searchData = {}
          if (type == 'tag') {
            searchData = {
              include_post_raw: 1,
              count: 200,
              tags: query,
              order: sort,
            }
          } else if (type == 'keyword') {
            searchData = {
              include_post_raw: 1,
              count: 200,
              q: query,
              order: sort,
            }
          }

          $('#searchResults').empty()
          $('#streamSpinner').velocity('fadeIn')

          $.ajax({
            url: 'https://api.pnut.io/v0/posts/search',
            type: 'GET',
            headers: { Authorization: 'Bearer ' + token },
            data: searchData,
            success: function (result) {
              console.log(query, result)

              if (result.data.length) {
                var prependHTML = ''
                for (var i in result.data) {
                  if (!result.data[i].is_deleted) {
                    var postDate = new Date(
                      result.data[i].created_at
                    ).toLocaleString()
                    var postRelativeDate = getRelativeDate(postDate)
                    var postImage = ''
                    var repostInfo = ''
                    var displayname = ''

                    var deleteButton,
                      postclass = ''

                    if ('repost_of' in result.data[i]) {
                      repostInfo =
                        ' <span class="repostedUsername"><span class="fa fa-retweet"></span> ' +
                        result.data[i].user.username +
                        '</span>'

                      result.data[i] = result.data[i].repost_of
                    }

                    if (result.data[i].user.id == myUserId) {
                      postclass = postclass + ' post-mypost'
                    } else {
                      deleteButton = ''
                    }

                    if (result.data[i].you_bookmarked) {
                      postclass = postclass + ' post-bookmarked'
                    }

                    if (result.data[i].you_reposted) {
                      postclass = postclass + ' post-reposted'
                    }

                    if (result.data[i].user.name != undefined) {
                      displayname =
                        '<span class="displayname">' +
                        result.data[i].user.name +
                        '</span>'
                    }

                    if ('raw' in result.data[i]) {
                      if (result.data[i].raw.length) {
                        for (var j in result.data[i].raw) {
                          if (result.data[i].raw[j].value.type == 'photo') {
                            var imgUrl = result.data[i].raw[j].value.url
                            if (imgUrl.startsWith('http')) {
                              postImage =
                                postImage +
                                '<a href="' +
                                imgUrl +
                                '"><img class="postimage" src="' +
                                imgUrl +
                                '"></a><br>'
                            }
                          }
                        }
                      }
                    }
                    if (result.data[i].content.entities.links.length) {
                      for (var j in result.data[i].content.entities.links) {
                        var url = result.data[i].content.entities.links[j].link
                        if (
                          url.match(/.*\.png|.*\.jpeg|.*\.jpg|.*\.gif/) &&
                          url.startsWith('http')
                        ) {
                          postImage =
                            postImage +
                            '<a href="' +
                            url +
                            '"><img class="postimage" src="' +
                            url +
                            '"></a><br>'
                        }
                      }
                    }

                    $('.post-latest').removeClass('post-latest')

                    prependHTML =
                      prependHTML +
                      '<div class="post post-latest' +
                      postclass +
                      '" post_id=' +
                      result.data[i].id +
                      ' post_created_at="' +
                      result.data[i].created_at +
                      '" style="display: none;">' +
                      '<img class="usericon" src="' +
                      result.data[i].user.content.avatar_image.link +
                      '">' +
                      '<div class="postcontent">' +
                      '<div class="usernameArea">' +
                      '<span class="username">' +
                      result.data[i].user.username +
                      '</span> ' +
                      displayname +
                      repostInfo +
                      '</div>' +
                      '<div class="postdate">' +
                      '<span class="postDateText"><span class="postRelDateText">' +
                      postRelativeDate +
                      '</span></span>' +
                      '<div class="postcontrol">' +
                      '<span class="fa fa-reply fa-fw postReplyButton"></span>' +
                      '<span class="fa fa-star fa-fw postStarButton"></span>' +
                      '<span class="fa fa-retweet fa-fw postRepostButton"></span>' +
                      '<span class="fa fa-trash-o fa-fw postDeleteButton"></span>' +
                      '<span class="fa fa-ellipsis-h fa-fw postDetailButton"></span>' +
                      '</div>' +
                      '</div>' +
                      '<div class="posttext">' +
                      result.data[i].content.html +
                      '</div>' +
                      postImage +
                      '</div>' +
                      '</div>'
                  }
                }

                $('#searchResults').append(prependHTML)
                $('.post-latest').velocity('slideDown', {
                  duration: 300,
                  delay: 300,
                })
              } else {
                $('#searchResults').append(
                  '<div id="searchNoResults">(｡>﹏<｡)<br>No search results for "' +
                    query +
                    '".</div>'
                )
              }

              $('#streamSpinner').velocity('fadeOut', { duration: 300 })
            },
          })
        }
      }

      $(document).on('keydown', '#searchInput', function (e) {
        if (e.keyCode == 13) {
          $('#searchButton').velocity('fadeOut')
          $('#searchClearButton').velocity('fadeIn')
          search(
            $('#searchInput').val(),
            $('select[name="searchTypeSelect"]').val(),
            $('select[name="searchSortSelect"]').val()
          )
        }
      })

      $(document).on('click', '#searchButton', function () {
        $('#searchButton').velocity('fadeOut')
        $('#searchClearButton').velocity('fadeIn')
        search(
          $('#searchInput').val(),
          $('select[name="searchTypeSelect"]').val(),
          $('select[name="searchSortSelect"]').val()
        )
      })

      $(document).on(
        'change',
        'select[name="searchSortSelect"], select[name="searchTypeSelect"]',
        function () {
          $('#searchButton').velocity('fadeOut')
          $('#searchClearButton').velocity('fadeIn')
          search(
            $('#searchInput').val(),
            $('select[name="searchTypeSelect"]').val(),
            $('select[name="searchSortSelect"]').val()
          )
        }
      )

      $(document).on('click', '#searchClearButton', function () {
        $('#searchResults .post').velocity('fadeOut', {
          complete: $('#searchResults .post').remove(),
        })
        $('#searchInput').val('')
        $('#searchNoResults').remove()
        $('#searchInput').focus()
        $('#searchButton').velocity('fadeIn')
        $('#searchClearButton').velocity('fadeOut')
      })

      function closePostThread() {
        $('.postthread, .postthread-titlebar').velocity(
          { marginTop: window.innerHeight },
          {
            duration: 250,
            easing: 'easeInCubic',
          }
        )

        $('.postthread-close').velocity('fadeOut')

        setTimeout(function () {
          $('.postthread, .postthread-titlebar').remove()
        }, 500)
      }

      function getRelativeDate(targetDateStr, force) {
        if (force == null) {
          force = false
        }

        var nowDate = new Date()
        var targetDate = new Date(targetDateStr)

        var elapsedTime = Math.ceil((nowDate.getTime() - targetDate.getTime()) / 1000)

        var message = null

        if (store.get('absoluteDate', false) == false || force == true) {
          if (elapsedTime < 60) {
            message = 'now'
          } else if (elapsedTime < 60 * 60) {
            //  1 時間未満
            message = Math.floor(elapsedTime / 60) + 'm'
          } else if (elapsedTime < 24 * 60 * 60) {
            //  1 日未満
            message = Math.floor(elapsedTime / 3600) + 'h'
          } else if (elapsedTime < 7 * 24 * 60 * 60) {
            // 1 週間未満
            message = Math.floor(elapsedTime / 86400) + 'd'
          } else {
            // 1 週間以上
            message = Math.floor(elapsedTime / 604800) + 'w'
          }
        } else {
          if (nowDate.toLocaleDateString() == targetDate.toLocaleDateString()) {
            message = targetDate.toLocaleTimeString()
          } else {
            message = targetDate.toLocaleString()
          }
        }

        return message
      }

      function notify(title, content, onClickCallback) {
        var notification = window.Notification
        var instance = new Notification(title, {
          body: content,
        })
        instance.onclick = function () {
          ipcRenderer.send('winRestore')
          onClickCallback()
        }
      }
    </script>
    <style>
      body {
        margin: 0;
        font-family: sans-serif;
        font-size: 10pt;
        -webkit-user-select: none;
        background: transparent;
      }

      #titlebar {
        width: 100%;
        height: 39px;
        overflow: hidden;
        -webkit-app-region: drag;
        position: fixed;
        vertical-align: middle;
        background-color: rgba(0, 0, 0, 0.3);
        color: #bbb;
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        top: 0;
        z-index: 10;
      }

      #titlebar-center {
        margin-left: auto;
        margin-right: auto;
        margin-top: 10px;
        text-align: center;
      }

      #titlebar-center .titlebar-button {
        width: 24px;
      }

      .titlebar-button.unread-indicator:after {
        content: '';
        height: 8px;
        width: 8px;
        background-color: #f00;
        border-radius: 8px;
        position: absolute;
        top: 1px;
        right: -1px;
      }

      #titlebar-edge {
        position: absolute;
        top: 10px;
      }

      .titlebar-button {
        -webkit-app-region: no-drag;
        cursor: pointer;
        font-size: 20px;
        text-shadow: 0 1px 1px rgba(0, 0, 0, 0.1);
        position: relative;
      }

      .titlebar-button:active {
        color: #fff;
      }

      #windowControl {
        position: fixed;
        right: 0;
        top: 0;
        z-index: 101;
      }

      #windowControl span {
        -webkit-app-region: no-drag;
        vertical-align: middle;
        display: inline-block;
        width: 40px;
        height: 40px;
        line-height: 40px;
        text-align: center;
      }

      #windowControl svg {
        margin: 14px;
        height: 12px;
      }

      #windowControl span:hover {
        background-color: rgba(255, 255, 255, 0.25);
      }
      #windowControl #winClose:hover {
        background-color: #f00;
        color: #fff;
      }

      #titlebar.titlebar-profiletab {
        border-bottom: 0;
        transition: 0.5s cubic-bezier(0.215, 0.61, 0.355, 1);
      }

      #titlebar.titlebar-profiletab:hover {
        background-color: rgba(0, 0, 0, 0.75) !important;
      }

      #windowContents {
        position: absolute;
        top: 40px;
        bottom: 0;
        left: 0;
        right: 0;
        overflow: hidden;
        background-color: #fff;
        z-index: 3;

        transition: color 1s ease-in-out, background-color 1s ease-in-out;
      }

      .streams {
        height: 100%;
        overflow-y: scroll;
      }

      .theme-dark #windowContents {
        background-color: #222;
        color: #ddd;
      }

      .theme-cyber #windowContents {
        background: linear-gradient(to bottom, #104, #505);
        background-color: #404;
        color: #eee;
      }

      #composeScreen {
        position: relative;
        display: none;
        padding-top: 8px;
        padding-left: 8px;
        padding-right: 8px;
        padding-bottom: 10px;
        z-index: 30;
        background-color: #f3f3f3;
        border-bottom: 1px solid #ddd;
      }

      #composeSpinner,
      #streamSpinner {
        position: fixed;
        top: 50%;
        left: 50%;
        margin-top: -12px;
        margin-left: -12px;
        width: 24px;
        height: 24px;
        font-size: 24px;
        text-align: center;
      }

      #composeSpinner {
        position: absolute;
        display: none;
      }

      #composeScreen .usericon {
        float: left;
      }

      #innerComposeScreen {
        margin-left: 8px;
        float: left;
      }

      #composeTextArea {
        width: 100%;
        height: auto;
        outline: 0;
        resize: none;
        border: 0;
        background-color: #f3f3f3;
        font-family: sans-serif;
        font-size: 10pt;
      }

      #composeScreen button,
      #composeInfoArea {
        font-size: 9pt;
      }

      #composeInfoArea {
        float: left;
        color: #666;
        margin-left: 2px;
        margin-top: 3px;
      }

      label[for='composeScreenFile'] {
        cursor: pointer;
      }

      #composeScreenIrtInfo {
        color: #555;
        font-size: 8pt;
        margin-bottom: 8px;
      }

      span[itemprop='mention'],
      span[itemprop='tag'],
      a {
        color: #999;
        cursor: pointer;
      }

      .theme-dark span[itemprop='mention'],
      .theme-dark span[itemprop='tag'],
      .theme-dark a {
        color: #bbb;
      }

      .theme-cyber span[itemprop='mention'],
      .theme-cyber span[itemprop='tag'],
      .theme-cyber a {
        color: #dd4;
        text-shadow: 0 0 10px #cc3;
      }

      .post {
        padding: 8px;
        border-bottom: 1px solid #ddd;
        min-height: 48px;
        overflow-wrap: break-word;
      }

      .theme-dark .post {
        border-bottom: 1px solid #333;
      }

      .theme-cyber .post {
        border-bottom: 1px solid rgba(222, 222, 255, 0.75);
      }

      .postStarButton,
      .postRepostButton {
        transition: 0.25s linear color;
      }

      .post.post-bookmarked .postStarButton {
        color: #e8d333;
      }
      .post.post-reposted .postRepostButton {
        color: #2fd445;
      }

      .post:not(.post-mypost) .postDeleteButton {
        display: none;
      }
      .post-mypost .postRepostButton {
        display: none;
      }

      .usericon {
        width: 48px;
        height: 48px;
        border-radius: 5px;
        transition: border-radius 1s ease-in-out;
        cursor: pointer;
      }

      .streams-rounded-icon .usericon {
        border-radius: 48px;
      }

      .postcontent {
        margin-left: 58px;
        margin-top: -52px;
        position: relative;
      }

      .username {
        cursor: pointer;
        font-weight: bold;
      }

      .theme-cyber .username {
        color: #f6d;
        text-shadow: 0 0 10px #f6d;
      }

      .usernameArea {
        margin-bottom: 3px;
        overflow-wrap: normal;
        width: calc(100% - 85px);
        padding-right: -100px;
        float: left;
      }

      .post-interaction .usernameArea {
        width: calc(100% - 50px);
      }

      .repostedUsername {
        color: #999;
        font-weight: normal;
      }

      .postdate,
      .postvia,
      .postcounts {
        position: relative;
        text-align: right;
        float: right;
        color: #999;
        font-size: 9pt;
      }

      .displayname {
        display: none;

        color: #999;
        font-size: 9pt;
      }

      .streams-show-displayname .displayname {
        display: inline;
      }

      #profileFollowers .displayname,
      #profileFollowing .displayname {
        display: inline;
      }

      .theme-cyber .postdate,
      .theme-cyber .postvia,
      .theme-cyber .postcounts,
      .theme-cyber .postthread-postdatetext {
        color: #5ff;
        text-shadow: 0 0 10px #4ee;
      }
      .theme-cyber .postcontrol {
        color: #fff;
      }

      .postthread-postdatetext {
        color: #999;
        font-size: 9pt;
        margin-top: 5px;
      }

      .postcounts {
        float: right;
        text-align: right;
        margin-top: 4px;
      }

      .postvia {
        margin-top: 3px;
        float: left;
        text-align: left;
      }

      .postcontrol {
        font-size: 12pt;
        width: 85px;
        text-align: right;
        position: absolute;
        top: 0;
        right: 0;
        display: none;
      }

      .postcontrol span {
        cursor: pointer;
      }

      .posttext {
        clear: both;
        -webkit-user-select: text;
      }

      .posttext a {
        /* word-break: break-all; */
      }

      .postimage {
        margin-top: 8px;
        width: 100%;
        height: auto;
      }

      .post-interaction .posttext,
      .post-bookmarked-by,
      .post-reposted-by {
        border: 1px solid #ccc;
        border-radius: 2px;
        background-color: #eee;
        padding: 8px;
        cursor: pointer;
      }

      .theme-dark .post-interaction .posttext,
      .theme-dark .post-bookmarked-by,
      .theme-dark .post-reposted-by {
        background-color: #333;
        border: 1px solid #222;
      }

      .theme-cyber .post-interaction .posttext,
      .theme-cyber .post-bookmarked-by,
      .theme-cyber .post-reposted-by {
        background-color: #457;
        border: 1px solid #346;
      }

      .postthread {
        position: fixed;
        top: 40px;
        background-color: inherit;
        width: 100%;
        height: 100%;
        z-index: 14;
        overflow-y: scroll;
      }

      .postthread-mentions,
      .postthread-mentions .postcontrol {
        background-color: #eee;
      }

      .theme-dark .postthread-mentions,
      .theme-dark .postthread-mentions .postcontrol {
        background-color: #111;
      }

      .theme-cyber .postthread-mentions,
      .theme-cyber .postthread-mentions .postcontrol {
        background-color: #202;
      }

      .postthread .posttext {
        font-size: 11pt;
      }

      .postthread-mentions .posttext {
        font-size: 9pt;
      }

      .post-bookmarked-by,
      .post-reposted-by {
        margin-top: 4px;
      }
      .post-bookmarked-by .post,
      .post-reposted-by .post {
        min-height: 20px;
        border-bottom: 0;
        padding: 0;
        margin: 0;
        margin-top: 8px;
      }
      .post-bookmarked-by .usericon,
      .post-reposted-by .usericon {
        width: 20px;
        height: 20px;
        vertical-align: middle;
      }

      .postthread-titlebar {
        position: fixed;
        padding-top: 12px;
        top: 0;
        left: 0;
        width: 100%;
        height: 28px;
        font-size: 11pt;
        text-align: center;
        color: #fff;
        background-color: #46c;
        z-index: 20;
      }

      .post-mentioned-me {
        background-color: #e8f5ff;
      }

      .theme-dark .post-mentioned-me {
        background-color: #333;
      }

      .theme-cyber .post-mentioned-me {
        background-color: rgba(255, 255, 255, 0.25);
      }

      #profileFollowers p,
      #profileFollowing p {
        margin-top: 8px;
        margin-bottom: 0;
      }

      .profileBio {
        color: #666;
        font-size: 9pt;
      }

      #profileFollowers .post,
      #profileFollowing .post {
        cursor: pointer;
      }

      #profile {
        text-align: center;
      }

      #profileOptionButton,
      #profileOptionCloseButton {
        color: #666;
        background: none;
        border: none;
        font-size: 13pt;
        padding-top: 2px;
        padding-right: 4px;
        outline: 0;
        cursor: pointer;
      }

      #profileFollowInfo {
        position: relative;
        text-align: left;
        border-top: 1px solid #ddd;
        background-color: #eee;

        overflow: hidden;

        padding-top: 11px;
        padding-bottom: 5px;

        padding-left: 11px;
        padding-right: 11px;
      }

      #profileOptionMenu {
        position: absolute;
        background-color: inherit;

        padding-top: 11px;
        padding-bottom: 5px;
        padding-left: 11px;
        padding-right: 11px;

        left: 0;
        top: 0;
        bottom: 0;
        right: 0;
        transform: translateX(100%);
      }

      .theme-dark #profileFollowInfo {
        border-top: 1px solid #666;
      }

      #profileOptionCloseButton {
        float: right;
      }

      .profile-action-button {
        border-radius: 5px;
        outline: 0;
        cursor: pointer;
        padding: 6px;
        border: none;
        color: #fff;
        background-color: #111;
        border: 1px solid #000;
        transition: background-color 0.25s ease-in, color 0.25s ease-in,
          border 0.25s ease-in, color 0.25s ease-in;
      }

      #profileBlockButton,
      .profile-you-blocked #profileFollowButton {
        background-color: #c44;
        border-color: #b33;
      }

      #profileMuteButton {
        background-color: #d80;
        border-color: #c80;
      }

      .profile-you-blocked #profileMuteButton {
        display: none;
      }

      #profileOpenWebButton {
        /* background-color: #382;
                border-color: #271; */
      }

      #profileFollowsYouLabel,
      #profileMutedLabel {
        display: inline-block;
        font-size: 9pt;
        color: #666;
        margin-left: 5px;
      }

      #profileMutedLabel {
        cursor: pointer;
      }

      .profile-you-follow #profileFollowButton {
        background-color: #3ad;
        border-color: #3ad;
        color: #fff;
      }

      .profile-you-not-follow #profileFollowButton {
        background-color: #fff;
        border-color: #3ad;
        color: #3ad;
      }

      #profileHeaderImage {
        position: fixed;
        z-index: 12;
        height: 140px;
        top: -30px;
        left: -30px;
        right: -30px;
        padding-bottom: 30px;
        background-size: cover;
        background-position: center;
        overflow: hidden;
      }

      #profileAvatar {
        position: relative;
        z-index: 13;
        width: 72px;
        height: 72px;
        margin-left: auto;
        margin-right: auto;
        margin-top: 64px;
        border-radius: 5px;
      }

      #profileDetails {
        border-bottom: 1px solid #ddd;
      }

      .theme-dark #profileDetails {
        border-bottom: 1px solid #666;
      }

      #profileUsernameArea {
        margin-top: 10px;
      }

      #profileBio {
        margin-top: 10px;

        margin-left: 10px;
        margin-right: 10px;

        margin-bottom: 20px;
      }

      #profileDisplayname {
        font-size: 18pt;
        font-weight: bold;
      }

      #profileUsername {
        font-size: 9pt;
        color: #666;
      }

      #profileCounts {
        cursor: pointer;
        background-color: #eee;
      }

      #profileCounts div {
        display: inline-block;
        vertical-align: middle;
        padding-top: 5px;
        padding-bottom: 2px;
        width: 23%;
        font-weight: bolder;
        border-bottom: 5px solid transparent;
      }

      #profileCounts .profile-counts-selected {
        border-bottom: 5px solid #bbb;
      }

      .profile-tab {
        text-align: left;
      }

      .profile-counts-icon-label {
        font-weight: lighter;
        font-size: 8pt;
      }

      .theme-dark #profileCounts,
      .theme-dark #profileFollowInfo {
        background-color: #333;
      }

      .theme-cyber #profileCounts,
      .theme-cyber #profileFollowInfo {
        background-color: rgba(255, 255, 255, 0.5);
      }

      .bottomNotify {
        display: none;
        position: fixed;
        width: 100%;
        color: white;
        font-size: 9pt;
        bottom: 0;
        z-index: 50;
      }

      #updateNotify {
        background-color: #46c;
      }

      #updateNotify a {
        color: white;
        cursor: pointer;
      }

      #updateNotifyClose {
        display: block;
        position: absolute;
        right: 8px;
        bottom: 8px;
      }

      #hiddenFeatureNotify {
        color: white;
        background-color: magenta;
      }

      #hiddenFeatureOverlay {
        position: fixed;
        top: 0;
        left: 0;
        bottom: 0;
        right: 0;
        z-index: 100;
        background-color: #000;
      }

      #hiddenFeatureOverlay img {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        width: 100%;
        height: auto;
      }

      .postthread-close {
        position: fixed;
        font-size: 11pt;
        text-align: center;
        line-height: 40px;
        width: 100%;
        height: 40px;
        color: white;
        display: none;
        background-color: #46c;
        cursor: pointer;
        z-index: 20;
      }

      #search {
        overflow: hidden;
      }

      #searchOptions {
        background-color: #eee;
        height: 68px;
        border-bottom: 1px solid #ddd;
        font-size: 10pt;
      }

      .theme-dark #searchOptions {
        color: white;
        background-color: #222;
        border-bottom: 1px solid #333;
      }

      #searchInput {
        width: 100%;
        font-size: 11pt;
        height: 16px;
        padding: 8px;
        outline: 0;
        margin-left: 20px;
        border: 0;
        background-color: #eee;
        border-bottom: 1px solid #ddd;
      }

      #searchTypeSelect {
        margin: 8px;
        position: absolute;
        top: -1px;
        right: 0;
        width: 80px;
        outline: 0;
      }

      #searchDetailOptions {
        margin: 8px;
      }

      #searchSortSelect {
        margin: 8px;
        outline: 0;
      }

      .theme-dark #searchInput {
        color: white;
        background-color: #222;
        border-bottom: 1px solid #333;
      }

      #searchButton {
        position: absolute;
        left: 0;
        top: 1px;
        font-size: 11pt;
        padding: 8px;
      }

      #searchClearButton {
        position: absolute;
        left: 0;
        top: 2px;
        font-size: 11pt;
        padding: 8px;
        cursor: pointer;

        display: none;
      }

      #searchResults {
        position: absolute;
        top: 68px;
        bottom: 0;
        left: 0;
        right: 0;
        overflow-y: scroll;
        overflow-x: hidden;
      }

      #searchNoResults {
        position: absolute;
        margin-top: -50px;
        color: #666;
        top: 50%;
        width: 100%;
        font-size: 12pt;
        text-align: center;
        font-style: italic;
      }

      #searchNoResults::first-line {
        font-size: 24pt;
        font-style: normal;
      }
    </style>
  </head>
  <body>
    <div id="titlebar">
      <div id="titlebar-center">
        <span
          class="titlebar-button fa fa-home"
          id="streamButton"
          style="color: #fff;"
        ></span>
        <span class="titlebar-button fa fa-at" id="mentionsButton"></span>
        <span
          class="titlebar-button fa fa-bullseye"
          id="interactionsButton"
        ></span>
        <span class="titlebar-button fa fa-globe" id="globalButton"></span>
        <span class="titlebar-button fa fa-user" id="myProfileButton"></span>
        <span class="titlebar-button fa fa-search" id="searchTabButton"></span>
      </div>
      <div id="titlebar-edge">
        <span class="titlebar-button fa fa-pencil" id="composeButton"></span>
      </div>
    </div>
    <div id="windowContents">
      <div id="composeScreen">
        <div id="composeSpinner">
          <span class="fa fa-refresh fa-spin"></span>
        </div>
        <img src="" class="usericon" />
        <div id="innerComposeScreen">
          <textarea
            id="composeTextArea"
            placeholder="Say something..."
          ></textarea
          ><br />
          <div id="composeInfoArea">
            <span id="composeCharRemain">256</span>
          </div>
          <!-- <div id="composeInfo"></div> -->
          <div style="float: right;">
            <span id="composeFileArea">
              <label for="composeScreenFile"
                ><span class="fa fa-picture-o"></span><sup>+</sup></label
              >
              <input
                type="file"
                accept="image/*"
                name="composeScreenFile"
                id="composeScreenFile"
                style="display: none;"
              />
            </span>
            <button id="composeCancelButton">Cancel</button>
            <button id="composePostButton">Post</button>
          </div>
          <div style="clear: both;"></div>
        </div>
        <div style="clear: both;"></div>
      </div>
      <div id="streamSpinner">
        <span class="fa fa-refresh fa-spin"></span>
      </div>
      <div id="stream" class="streams"></div>
      <div id="mentions" class="streams" style="display: none;"></div>
      <div id="interactions" class="streams" style="display: none;"></div>
      <div id="global" class="streams" style="display: none;"></div>
      <div id="profile" class="streams" style="display: none;">
        <div id="profileHeaderImage"></div>
        <img id="profileAvatar" />
        <div id="profileDetails">
          <p id="profileUsernameArea">
            <span id="profileDisplayname">displayname</span><br />
            <span id="profileUsername">@username</span>
          </p>
          <p id="profileBio"></p>
          <div id="profileFollowInfo">
            <div style="float: left;">
              <button id="profileFollowButton" class="profile-action-button">
                Follow
              </button>
              <span id="profileFollowsYouLabel" style="display: none;"
                >Follows You</span
              >
            </div>
            <div style="float: right;">
              <span id="profileMutedLabel" style="display: none;"
                ><span class="fa fa-eye-slash"></span> Muted</span
              >
              <button id="profileOptionButton">
                <span class="fa fa-gear"></span>
              </button>
            </div>
            <div style="clear: both;"></div>
            <div id="profileOptionMenu">
              <button class="profile-action-button" id="profileBlockButton">
                <span class="fa fa-ban"></span> Block
              </button>
              <button class="profile-action-button" id="profileMuteButton">
                <span class="fa fa-eye-slash"></span> Mute
              </button>
              <button class="profile-action-button" id="profileEditButton">
                <span class="fa fa-pencil"></span> Edit Profile
              </button>
              <button class="profile-action-button" id="profileOpenWebButton">
                <span class="fa fa-globe"></span> Open in pnut.io
              </button>
              <button id="profileOptionCloseButton">
                <span class="fa fa-close"></span>
              </button>
              <div style="clear: both;"></div>
            </div>
          </div>
          <div id="profileCounts">
            <div id="profileFollowingButton">
              <span class="profile-counts-icon-label">Following</span><br />
              <span class="fa fa-user-circle-o"></span
              ><span
                class="fa fa-arrow-circle-right"
                style="font-size: 10pt; margin-left: -3px;"
              ></span>
              <span id="profileFollowingCount">0</span><br />
            </div>
            <div id="profileFollowersButton">
              <span class="profile-counts-icon-label">Followers</span><br />
              <span class="fa fa-user-circle-o"></span
              ><span
                class="fa fa-arrow-circle-left"
                style="font-size: 10pt; margin-left: -3px;"
              ></span>
              <span id="profileFollowersCount">0</span><br />
            </div>
            <div id="profilePostsButton" class="profile-counts-selected">
              <span class="profile-counts-icon-label">Posts</span><br />
              <span class="fa fa-comment"></span>
              <span id="profilePostsCount">0</span><br />
            </div>
            <div id="profileBookmarksButton">
              <span class="profile-counts-icon-label">Bookmarks</span><br />
              <span class="fa fa-star"></span>
              <span id="profileBookmarksCount">0</span><br />
            </div>
          </div>
        </div>
        <div id="profileStream" class="profile-tab"></div>
        <div
          id="profileFollowers"
          class="profile-tab"
          style="display: none;"
        ></div>
        <div
          id="profileFollowing"
          class="profile-tab"
          style="display: none;"
        ></div>
        <div
          id="profileBookmarks"
          class="profile-tab"
          style="display: none;"
        ></div>
      </div>
      <div id="search" class="streams" style="display: none;">
        <div id="searchOptions">
          <input type="text" placeholder="Search pnut.io" id="searchInput" />
          <div id="searchButton" class="fa fa-search"></div>
          <div id="searchClearButton" class="fa fa-times-circle"></div>
          <select name="searchTypeSelect" id="searchTypeSelect">
            <option value="keyword">Keyword</option>
            <option value="tag">Tag</option>
          </select>
          <span id="searchDetailOptions">
            Sort by<select name="searchSortSelect" id="searchSortSelect">
              <option value="id">Time</option>
              <option value="relevance">Relevance</option>
            </select>
          </span>
        </div>
        <div id="searchResults"></div>
      </div>
      <div id="updateNotify" class="bottomNotify">
        <div style="margin: 8px;">
          <span class="fa fa-info-circle"></span> New version
          <span id="updateNotifyNewVersion"></span> available.
          <a href="http://kyo5884.tk/enuts">Download</a>
          <a id="updateNotifyClose" class="fa fa-close"></a>
        </div>
      </div>
      <div id="hiddenFeatureNotify" class="bottomNotify">
        <div style="margin: 8px;">
          <span class="fa fa-info-circle"></span> Hidden feature enabled.
        </div>
      </div>
    </div>

    <div class="postthread-close">
      <span id="backToStreamIcon" class="fa fa-chevron-left"></span> Back to
      stream
    </div>
  </body>
</html>
